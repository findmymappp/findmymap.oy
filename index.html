<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
<title>Find My Map</title>
<style>
  body, html {
    margin: 0; padding: 0; height: 100%;
    font-family: Arial, sans-serif;
    -webkit-touch-callout: none; /* iOS Safari */
    -webkit-user-select: none; /* Safari */
    -khtml-user-select: none; /* Konqueror HTML */
    -moz-user-select: none; /* Firefox */
    -ms-user-select: none; /* IE/Edge */
    user-select: none;
    background: #fff;
    display: flex; flex-direction: column;
  }
  #map {
    width: 100%;
    height: 55vh; /* 지도 높이 */
  }
  #controls {
    padding: 10px;
    background: #f9f9f9;
    flex-grow: 1;
    display: flex; flex-direction: column;
  }
  #language-select {
    position: absolute;
    top: 10px;
    right: 10px;
    z-index: 9999;
    font-size: 14px;
  }
  .destination-buttons {
    margin-top: 10px;
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }
  button.dest-btn {
    background-color: #4CAF50;
    border: none;
    color: white;
    padding: 12px 16px;
    font-size: 14px;
    border-radius: 6px;
    cursor: pointer;
    flex-grow: 1;
    min-width: 140px;
  }
  button.dest-btn:hover {
    background-color: #45a049;
  }
  #info {
    margin-top: 15px;
    font-size: 16px;
    min-height: 40px;
    line-height: 1.3;
    color: #333;
  }
  #refreshBtn {
    margin-top: 12px;
    padding: 8px 12px;
    font-size: 14px;
    border-radius: 5px;
    border: 1.5px solid #4CAF50;
    background: white;
    color: #4CAF50;
    cursor: pointer;
    align-self: flex-start;
  }
  #refreshBtn:hover {
    background: #4CAF50;
    color: white;
  }
</style>
<script src="//dapi.kakao.com/v2/maps/sdk.js?appkey=7984bae577e26f048c7b8608f9008187&libraries=services"></script>
</head>
<body>
<select id="language-select" aria-label="Select language">
  <option value="en" selected>English</option>
  <option value="ko">한국어</option>
  <option value="ja">日本語</option>
  <option value="zh">中文</option>
</select>

<div id="map"></div>

<div id="controls">
  <div class="destination-buttons" id="dest-buttons">
    <!-- 목적지 버튼들 동적 생성 -->
  </div>
  <button id="refreshBtn" aria-label="Refresh current location">Refresh Location</button>
  <div id="info" aria-live="polite"></div>
</div>

<script>
(() => {
  // 다국어 텍스트
  const texts = {
    en: {
      destNames: [
        "Olive Young Dongdaemun History & Culture Park 1F",
        "Olive Young Dunden Dongdaemun B2F",
        "Olive Young Doota B2F",
        "Olive Young Hyundai City Outlet 2F"
      ],
      refresh: "Refresh Location",
      distanceTime: (time) => `Estimated walking time: ${time}`,
      errorLoc: "Failed to get current location.",
      selectDest: "Please select a destination.",
    },
    ko: {
      destNames: [
        "올리브영 동대문역사문화공원역점 1F",
        "올리브영 던던동대문점 B2F",
        "올리브영 두타점 B2F",
        "올리브영 현대시티아울렛점 2F"
      ],
      refresh: "현재 위치 갱신",
      distanceTime: (time) => `도보 예상 소요시간: ${time}`,
      errorLoc: "현재 위치를 가져오지 못했습니다.",
      selectDest: "목적지를 선택해 주세요.",
    },
    ja: {
      destNames: [
        "オリーブヤング 東大門歴史文化公園駅 1F",
        "オリーブヤング ダンデン東大門 B2F",
        "オリーブヤング ドゥタ B2F",
        "オリーブヤング ヒュンダイシティアウトレット 2F"
      ],
      refresh: "現在地を更新",
      distanceTime: (time) => `徒歩の所要時間: ${time}`,
      errorLoc: "現在地を取得できませんでした。",
      selectDest: "目的地を選択してください。",
    },
    zh: {
      destNames: [
        "Olive Young 东大门历史文化公园站 1F",
        "Olive Young Dun Dun 东大门 B2F",
        "Olive Young Doota B2F",
        "Olive Young 现代城市奥特莱斯 2F"
      ],
      refresh: "刷新当前位置",
      distanceTime: (time) => `预计步行时间: ${time}`,
      errorLoc: "无法获取当前位置。",
      selectDest: "请选择目的地。",
    },
  };

  // 목적지 데이터
  const destinations = [
    { nameKey: 0, lat: 37.567081, lng: 127.008034, path: [
      { lat: 37.567081, lng: 127.008034 },
      { lat: 37.567300, lng: 127.008300 },
      { lat: 37.567600, lng: 127.008600 }
    ]},
    { nameKey: 1, lat: 37.565869, lng: 127.007215, path: [
      { lat: 37.565869, lng: 127.007215 },
      { lat: 37.566000, lng: 127.007400 },
      { lat: 37.566300, lng: 127.007700 }
    ]},
    { nameKey: 2, lat: 37.568779, lng: 127.008892, path: [
      { lat: 37.568779, lng: 127.008892 },
      { lat: 37.569000, lng: 127.009100 },
      { lat: 37.569300, lng: 127.009400 }
    ]},
    { nameKey: 3, lat: 37.568720, lng: 127.008003, path: [
      { lat: 37.568720, lng: 127.008003 },
      { lat: 37.568900, lng: 127.008200 },
      { lat: 37.569200, lng: 127.008500 }
    ]},
  ];

  // 전역 변수
  let map;
  let currentPositionMarker;
  let currentPosition = null;
  let polyline = null;
  let selectedDestination = null;
  let language = 'en';

  // 요소
  const mapContainer = document.getElementById('map');
  const destButtonsContainer = document.getElementById('dest-buttons');
  const infoDiv = document.getElementById('info');
  const refreshBtn = document.getElementById('refreshBtn');
  const langSelect = document.getElementById('language-select');

  // 지도 초기화 함수
  function initMap() {
    map = new kakao.maps.Map(mapContainer, {
      center: new kakao.maps.LatLng(37.5665, 126.9780), // 서울 중심 기본
      level: 5,
    });
  }

  // 현재 위치 마커 생성 또는 위치 이동
  function updateCurrentPositionMarker(position) {
    const latlng = new kakao.maps.LatLng(position.coords.latitude, position.coords.longitude);
    currentPosition = latlng;

    if (!currentPositionMarker) {
      currentPositionMarker = new kakao.maps.Marker({
        map: map,
        position: latlng,
        image: new kakao.maps.MarkerImage(
          'https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png',
          new kakao.maps.Size(24, 35)
        ),
      });
    } else {
      currentPositionMarker.setPosition(latlng);
    }
    map.setCenter(latlng);
  }

  // 경로 그리기 함수 (폴리라인)
  function drawRoute(path) {
    if (polyline) {
      polyline.setMap(null);
    }
    const linePath = path.map(p => new kakao.maps.LatLng(p.lat, p.lng));
    polyline = new kakao.maps.Polyline({
      path: linePath,
      strokeWeight: 5,
      strokeColor: '#ff0000',
      strokeOpacity: 0.8,
      strokeStyle: 'solid',
    });
    polyline.setMap(map);
    map.setBounds(polyline.getBounds());
  }

  // 도보 시간(예시) 계산 함수 (1분 단위로 문자열 반환)
  function getWalkingTime(distanceMeters) {
    const walkingSpeedMPerMin = 80; // 분당 80m 걷는다고 가정
    const timeMin = Math.ceil(distanceMeters / walkingSpeedMPerMin);
    return `${timeMin} min`;
  }

  // 목적지 버튼 생성
  function createDestinationButtons() {
    destButtonsContainer.innerHTML = '';
    destinations.forEach((dest, i) => {
      const btn = document.createElement('button');
      btn.className = 'dest-btn';
      btn.textContent = texts[language].destNames[dest.nameKey];
      btn.addEventListener('click', () => {
        if (!currentPosition) {
          alert(texts[language].errorLoc);
          return;
        }
        selectedDestination = dest;
        // 단순 거리 계산 (미터)
        const dist = kakao.maps.LatLng.prototype.distanceTo
          ? currentPosition.distanceTo(new kakao.maps.LatLng(dest.lat, dest.lng))
          : getDistance(currentPosition.getLat(), currentPosition.getLng(), dest.lat, dest.lng);

        // 도보 시간 계산
        const walkTime = getWalkingTime(dist);

        // 경로 그리기
        drawRoute(dest.path);

        // 안내 텍스트
        infoDiv.textContent = texts[language].distanceTime(walkTime);
      });
      destButtonsContainer.appendChild(btn);
    });
  }

  // 언어 변경 처리
  langSelect.addEventListener('change', () => {
    language = langSelect.value;
    refreshBtn.textContent = texts[language].refresh;
    createDestinationButtons();
    infoDiv.textContent = '';
  });

  // 현재 위치 갱신 버튼
  refreshBtn.addEventListener('click', () => {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          updateCurrentPositionMarker(pos);
          infoDiv.textContent = '';
          if(selectedDestination) {
            // 새 위치에서 다시 도보시간 업데이트
            const dist = kakao.maps.LatLng.prototype.distanceTo
              ? currentPosition.distanceTo(new kakao.maps.LatLng(selectedDestination.lat, selectedDestination.lng))
              : getDistance(currentPosition.getLat(), currentPosition.getLng(), selectedDestination.lat, selectedDestination.lng);
            const walkTime = getWalkingTime(dist);
            infoDiv.textContent = texts[language].distanceTime(walkTime);
          }
        },
        () => {
          alert(texts[language].errorLoc);
        }
      );
    } else {
      alert(texts[language].errorLoc);
    }
  });

  // 초깃값 세팅
  function init() {
    initMap();
    createDestinationButtons();
    refreshBtn.textContent = texts[language].refresh;

    // 현재 위치 자동 갱신 (초기 1회)
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        (pos) => updateCurrentPositionMarker(pos),
        () => alert(texts[language].errorLoc)
      );

      // 실시간 위치 업데이트 (움직임 반영)
      navigator.geolocation.watchPosition(
        (pos) => updateCurrentPositionMarker(pos)
      );
    } else {
      alert(texts[language].errorLoc);
    }
  }

  // 거리 계산 (직선거리)
  function getDistance(lat1, lng1, lat2, lng2) {
    function toRad(x) {
      return (x * Math.PI) / 180;
    }
    const R = 6371000; // 지구 반지름 (m)
    const dLat = toRad(lat2 - lat1);
    const dLng = toRad(lng2 - lng1);
    const a =
      Math.sin(dLat / 2) * Math.sin(dLat / 2) +
      Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
      Math.sin(dLng / 2) * Math.sin(dLng / 2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return R * c;
  }

  // 초기 실행
  init();
})();
</script>
</body>
</html>
